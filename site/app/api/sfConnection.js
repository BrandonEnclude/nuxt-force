const jsforce = require('jsforce')
const { getJWTToken } = require('salesforce-jwt-promise');
const fs = require('fs')

const sfConnection = {

    clientId: process.env.SF_CLIENT_ID, // Generated by SF Connected App
    privateKey: fs.readFileSync(__dirname + '/certificates/server.key').toString('utf8'), // SSL Certificate
    instanceUrl: process.env.SF_INSTANCE_URL, // Salesforce Instance URL
    userName: process.env.SF_USER, // Salesforce User username
    connection: null,

    getAccessToken: async function() {
        // Get JSON Web Token from Salesforce using our credentials
        const response = await getJWTToken({ clientId: this.clientId, privateKey: this.privateKey, userName: this.userName })
        return response.access_token
    },
    getConnection: async function() {
        if (this.connection) return this.connection // Always return existing connection if exists

        this.connection = new jsforce.Connection()  // Else create new connection
        await this.connection.initialize({
            instanceUrl: this.instanceUrl,
            accessToken: await this.getAccessToken()
        })
        return this.connection
    }
}

module.exports = sfConnection